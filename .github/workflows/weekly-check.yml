name: "ğŸ“Š ×‘×“×™×§×” ×©×‘×•×¢×™×ª - eliavafar.co.il"

on:
  schedule:
    # ×›×œ ×™×•× ×¨××©×•×Ÿ ×‘-08:00 ×©×¢×•×Ÿ ×™×©×¨××œ (06:00 UTC)
    - cron: '0 6 * * 0'
  workflow_dispatch: # ××¤×©×¨×•×ª ×œ×”×¨×¦×” ×™×“× ×™×ª ×-GitHub

jobs:
  weekly-check:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: "ğŸ” ×‘×“×™×§×ª ×“×¤×™ ×”××ª×¨"
        id: pages
        run: |
          SITE="https://eliavafar.co.il"
          PAGES=("/" "/bentonite-drilling" "/earthworks" "/drainage-pits" "/equipment-rental" "/contact" "/thanks")
          NAMES=("×“×£ ×¨××©×™" "×§×™×“×•×—×™ ×‘× ×˜×•× ×™×™×˜" "×¢×‘×•×“×•×ª ×¢×¤×¨" "×‘×•×¨×•×ª ×—×œ×—×•×œ" "×”×©×›×¨×ª ×¦×™×•×“" "×¦×•×¨ ×§×©×¨" "×“×£ ×ª×•×“×”")

          RESULTS=""
          ALL_OK=true

          for i in "${!PAGES[@]}"; do
            URL="${SITE}${PAGES[$i]}"
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$URL" 2>/dev/null)

            if [ "$STATUS" = "200" ]; then
              RESULTS="${RESULTS}| ${NAMES[$i]} | ${PAGES[$i]} | âœ… ${STATUS} |\n"
            else
              RESULTS="${RESULTS}| ${NAMES[$i]} | ${PAGES[$i]} | âŒ ${STATUS} |\n"
              ALL_OK=false
            fi
          done

          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ "$ALL_OK" = true ]; then
            echo "status=âœ… ×›×œ ×”×“×¤×™× ×ª×§×™× ×™×" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ ×™×© ×“×¤×™× ×¢× ×‘×¢×™×•×ª!" >> $GITHUB_OUTPUT
          fi

      - name: "ğŸ”’ ×‘×“×™×§×ª SSL"
        id: ssl
        run: |
          EXPIRY=$(echo | openssl s_client -servername eliavafar.co.il -connect eliavafar.co.il:443 2>/dev/null | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)

          if [ -n "$EXPIRY" ]; then
            EXPIRY_EPOCH=$(date -d "$EXPIRY" +%s 2>/dev/null)
            NOW_EPOCH=$(date +%s)
            DAYS_LEFT=$(( (EXPIRY_EPOCH - NOW_EPOCH) / 86400 ))

            if [ "$DAYS_LEFT" -gt 30 ]; then
              echo "status=âœ… SSL ×ª×§×£ - × ×•×ª×¨×• ${DAYS_LEFT} ×™××™× (×¢×“ ${EXPIRY})" >> $GITHUB_OUTPUT
            elif [ "$DAYS_LEFT" -gt 0 ]; then
              echo "status=âš ï¸ SSL ×¤×’ ×‘×§×¨×•×‘! × ×•×ª×¨×• ${DAYS_LEFT} ×™××™× ×‘×œ×‘×“!" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ SSL ×¤×’ ×ª×•×§×£!" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×‘×“×•×§ SSL" >> $GITHUB_OUTPUT
          fi

      - name: "âš¡ ×‘×“×™×§×ª ××”×™×¨×•×ª (PageSpeed)"
        id: speed
        run: |
          API="https://www.googleapis.com/pagespeedonline/v5/runPagespeed"
          URL="https://eliavafar.co.il"

          # ×¤×•× ×§×¦×™×” ×¢× retry ×œ××§×¨×” ×©×œ rate limit
          fetch_pagespeed() {
            local strategy=$1
            local result=""
            for attempt in 1 2 3; do
              result=$(curl -s -w "\n%{http_code}" --max-time 120 "${API}?url=${URL}&category=performance&strategy=${strategy}")
              local http_code=$(echo "$result" | tail -1)
              local body=$(echo "$result" | sed '$d')
              if [ "$http_code" = "200" ]; then
                echo "$body"
                return 0
              fi
              echo "Attempt ${attempt} failed (HTTP ${http_code}), waiting 30s..." >&2
              sleep 30
            done
            echo "{}"
            return 1
          }

          echo "Checking mobile speed..."
          MOBILE=$(fetch_pagespeed "mobile")
          MOBILE_SCORE=$(echo "$MOBILE" | jq -r '.lighthouseResult.categories.performance.score // empty' 2>/dev/null)
          if [ -n "$MOBILE_SCORE" ] && [ "$MOBILE_SCORE" != "null" ]; then
            MOBILE_SCORE=$(echo "$MOBILE_SCORE" | awk '{printf "%d", $1 * 100}')
          else
            MOBILE_SCORE="N/A"
          fi

          # ×”××ª× ×” ×‘×™×Ÿ ×”×‘×§×©×•×ª ×œ×× ×™×¢×ª rate limit
          echo "Waiting 10s between requests..."
          sleep 10

          echo "Checking desktop speed..."
          DESKTOP=$(fetch_pagespeed "desktop")
          DESKTOP_SCORE=$(echo "$DESKTOP" | jq -r '.lighthouseResult.categories.performance.score // empty' 2>/dev/null)
          if [ -n "$DESKTOP_SCORE" ] && [ "$DESKTOP_SCORE" != "null" ]; then
            DESKTOP_SCORE=$(echo "$DESKTOP_SCORE" | awk '{printf "%d", $1 * 100}')
          else
            DESKTOP_SCORE="N/A"
          fi

          MOBILE_LCP=$(echo "$MOBILE" | jq -r '.lighthouseResult.audits["largest-contentful-paint"].displayValue // "N/A"' 2>/dev/null)

          echo "Mobile: ${MOBILE_SCORE}, Desktop: ${DESKTOP_SCORE}, LCP: ${MOBILE_LCP}"

          echo "mobile=${MOBILE_SCORE}" >> $GITHUB_OUTPUT
          echo "desktop=${DESKTOP_SCORE}" >> $GITHUB_OUTPUT
          echo "lcp=${MOBILE_LCP}" >> $GITHUB_OUTPUT

          if [ "$MOBILE_SCORE" != "N/A" ] && [ "$MOBILE_SCORE" -ge 90 ]; then
            echo "mobile_icon=ğŸŸ¢" >> $GITHUB_OUTPUT
          elif [ "$MOBILE_SCORE" != "N/A" ] && [ "$MOBILE_SCORE" -ge 50 ]; then
            echo "mobile_icon=ğŸŸ¡" >> $GITHUB_OUTPUT
          else
            echo "mobile_icon=ğŸ”´" >> $GITHUB_OUTPUT
          fi

          if [ "$DESKTOP_SCORE" != "N/A" ] && [ "$DESKTOP_SCORE" -ge 90 ]; then
            echo "desktop_icon=ğŸŸ¢" >> $GITHUB_OUTPUT
          elif [ "$DESKTOP_SCORE" != "N/A" ] && [ "$DESKTOP_SCORE" -ge 50 ]; then
            echo "desktop_icon=ğŸŸ¡" >> $GITHUB_OUTPUT
          else
            echo "desktop_icon=ğŸ”´" >> $GITHUB_OUTPUT
          fi

      - name: "ğŸ”— ×‘×“×™×§×ª ×œ×™× ×§×™× ×©×‘×•×¨×™×"
        id: links
        run: |
          SITE="https://eliavafar.co.il"
          BROKEN=""
          BROKEN_COUNT=0

          # ×‘×“×™×§×ª ×œ×™× ×§×™× ×—×™×¦×•× ×™×™× ×—×©×•×‘×™×
          LINKS=(
            "https://wa.me/972529556123"
            "https://fonts.googleapis.com/css2?family=Heebo"
            "https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"
          )
          LINK_NAMES=(
            "WhatsApp"
            "Google Fonts"
            "Swiper CDN"
          )

          for i in "${!LINKS[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 -L "${LINKS[$i]}" 2>/dev/null)
            if [ "$STATUS" != "200" ] && [ "$STATUS" != "301" ] && [ "$STATUS" != "302" ]; then
              BROKEN="${BROKEN}| ${LINK_NAMES[$i]} | ${LINKS[$i]} | âŒ ${STATUS} |\n"
              BROKEN_COUNT=$((BROKEN_COUNT + 1))
            fi
          done

          if [ "$BROKEN_COUNT" -eq 0 ]; then
            echo "status=âœ… ×›×œ ×”×œ×™× ×§×™× ×”×—×™×¦×•× ×™×™× ×ª×§×™× ×™×" >> $GITHUB_OUTPUT
            echo "details=" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ × ××¦××• ${BROKEN_COUNT} ×œ×™× ×§×™× ×©×‘×•×¨×™×" >> $GITHUB_OUTPUT
            echo "details<<EOF" >> $GITHUB_OUTPUT
            echo -e "$BROKEN" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: "ğŸ“‹ ×™×¦×™×¨×ª ×“×•×— Issue"
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toLocaleDateString('he-IL', {
              year: 'numeric', month: 'long', day: 'numeric',
              timeZone: 'Asia/Jerusalem'
            });

            const pagesStatus = `${{ steps.pages.outputs.status }}`;
            const sslStatus = `${{ steps.ssl.outputs.status }}`;
            const mobileScore = `${{ steps.speed.outputs.mobile }}`;
            const desktopScore = `${{ steps.speed.outputs.desktop }}`;
            const mobileLcp = `${{ steps.speed.outputs.lcp }}`;
            const mobileIcon = `${{ steps.speed.outputs.mobile_icon }}`;
            const desktopIcon = `${{ steps.speed.outputs.desktop_icon }}`;
            const linksStatus = `${{ steps.links.outputs.status }}`;
            const linksDetails = `${{ steps.links.outputs.details }}`;

            const body = `## ğŸ“Š ×“×•×— ×©×‘×•×¢×™ - eliavafar.co.il
            **×ª××¨×™×š:** ${today}

            ---

            ### ğŸŒ ×¡×˜×˜×•×¡ ×“×¤×™×
            ${pagesStatus}

            | ×“×£ | × ×ª×™×‘ | ×¡×˜×˜×•×¡ |
            |----|------|-------|
            ${{ steps.pages.outputs.results }}

            ### ğŸ”’ ××‘×˜×—×” (SSL)
            ${sslStatus}

            ### âš¡ ××”×™×¨×•×ª
            | ××“×“ | ×¦×™×•×Ÿ |
            |-----|------|
            | ××•×‘×™×™×œ | ${mobileIcon} ${mobileScore}/100 |
            | ×“×¡×§×˜×•×¤ | ${desktopIcon} ${desktopScore}/100 |
            | LCP (××•×‘×™×™×œ) | ${mobileLcp} |

            ### ğŸ”— ×œ×™× ×§×™× ×—×™×¦×•× ×™×™×
            ${linksStatus}
            ${linksDetails ? '\n| ×©× | URL | ×¡×˜×˜×•×¡ |\n|----|-----|-------|\n' + linksDetails : ''}

            ---

            ### ğŸ“‹ ×ª×–×›×•×¨×ª - ×œ×‘×“×•×§ ×™×“× ×™×ª ×”×©×‘×•×¢:

            - [ ] **GA4** (analytics.google.com) - ×›××•×ª ××‘×§×¨×™×, ×”××¨×•×ª, ×“×¤×™× ×¤×•×¤×•×œ×¨×™×™×
            - [ ] **Clarity** (clarity.microsoft.com) - ×”×§×œ×˜×•×ª ××©×ª××©×™×, ××¤×•×ª ×—×•×
            - [ ] **Google Business** (business.google.com) - ×‘×™×§×•×¨×•×ª ×—×“×©×•×ª, ×œ×¢× ×•×ª ×¢×œ ×‘×™×§×•×¨×•×ª
            - [ ] **Search Console** (search.google.com/search-console) - ×©×’×™××•×ª, ××™×œ×•×ª ×—×™×¤×•×©

            ---
            *×“×•×— ××•×˜×•××˜×™ ×©× ×•×¦×¨ ×¢"×™ GitHub Actions*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š ×“×•×— ×©×‘×•×¢×™ - ${today}`,
              body: body,
              labels: ['weekly-report']
            });
