name: "ğŸ“Š ×‘×“×™×§×” ×©×‘×•×¢×™×ª - eliavafar.co.il"

on:
  schedule:
    # ×›×œ ×™×•× ×¨××©×•×Ÿ ×‘-08:00 ×©×¢×•×Ÿ ×™×©×¨××œ (06:00 UTC)
    - cron: '0 6 * * 0'
  workflow_dispatch: # ××¤×©×¨×•×ª ×œ×”×¨×¦×” ×™×“× ×™×ª ×-GitHub

jobs:
  weekly-check:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: "ğŸ” ×‘×“×™×§×ª ×›×œ ×“×¤×™ ×”××ª×¨ (22 ×“×¤×™×)"
        id: pages
        run: |
          SITE="https://eliavafar.co.il"

          # ×“×¤×™× ×¨××©×™×™× (9)
          MAIN_PAGES=("/" "/bentonite-drilling" "/earthworks" "/drainage-pits" "/equipment-rental" "/contact" "/thanks" "/blog" "/accessibility-statement")
          MAIN_NAMES=("×“×£ ×¨××©×™" "×§×™×“×•×—×™ ×‘× ×˜×•× ×™×™×˜" "×¢×‘×•×“×•×ª ×¢×¤×¨" "×‘×•×¨×•×ª ×—×œ×—×•×œ" "×”×©×›×¨×ª ×¦×™×•×“" "×¦×•×¨ ×§×©×¨" "×“×£ ×ª×•×“×”" "×‘×œ×•×’" "×”×¦×”×¨×ª × ×’×™×©×•×ª")

          # ××××¨×™ ×‘×œ×•×’ (13)
          BLOG_PAGES=("/blog/bentonite-guide" "/blog/drainage-pits-guide" "/blog/drilling-netanya" "/blog/earthworks-tips" "/blog/choose-drilling-contractor" "/blog/bentonite-vs-polymer" "/blog/drilling-hod-hasharon" "/blog/equipment-rental-guide" "/blog/contractor-license-guide" "/blog/site-development-guide" "/blog/drainage-pits-pricing" "/blog/waste-removal-guide" "/blog/foundation-piles-guide")
          BLOG_NAMES=("××“×¨×™×š ×‘× ×˜×•× ×™×™×˜" "××“×¨×™×š ×‘×•×¨×•×ª ×—×œ×—×•×œ" "×§×™×“×•×— × ×ª× ×™×”" "×˜×™×¤×™× ×¢×‘×•×“×•×ª ×¢×¤×¨" "×‘×—×™×¨×ª ×§×‘×œ×Ÿ ×§×™×“×•×—" "×‘× ×˜×•× ×™×™×˜ vs ×¤×•×œ×™××¨" "×§×™×“×•×— ×”×•×“ ×”×©×¨×•×Ÿ" "××“×¨×™×š ×”×©×›×¨×ª ×¦×™×•×“" "××“×¨×™×š ×¨×™×©×™×•×Ÿ ×§×‘×œ×Ÿ" "××“×¨×™×š ×¤×™×ª×•×— ×©×˜×—" "×ª××—×•×¨ ×‘×•×¨×•×ª ×—×œ×—×•×œ" "××“×¨×™×š ×¤×™× ×•×™ ×¤×¡×•×œ×ª" "××“×¨×™×š ×›×œ×•× ×¡××•×ª")

          MAIN_RESULTS=""
          BLOG_RESULTS=""
          FAIL_COUNT=0
          TOTAL=0

          # ×‘×“×™×§×ª ×“×¤×™× ×¨××©×™×™×
          for i in "${!MAIN_PAGES[@]}"; do
            URL="${SITE}${MAIN_PAGES[$i]}"
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 "$URL" 2>/dev/null)
            TOTAL=$((TOTAL + 1))

            if [ "$STATUS" = "200" ]; then
              MAIN_RESULTS="${MAIN_RESULTS}| ${MAIN_NAMES[$i]} | ${MAIN_PAGES[$i]} | âœ… ${STATUS} |\n"
            else
              MAIN_RESULTS="${MAIN_RESULTS}| ${MAIN_NAMES[$i]} | ${MAIN_PAGES[$i]} | âŒ ${STATUS} |\n"
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
          done

          # ×‘×“×™×§×ª ××××¨×™ ×‘×œ×•×’
          for i in "${!BLOG_PAGES[@]}"; do
            URL="${SITE}${BLOG_PAGES[$i]}"
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 "$URL" 2>/dev/null)
            TOTAL=$((TOTAL + 1))

            if [ "$STATUS" = "200" ]; then
              BLOG_RESULTS="${BLOG_RESULTS}| ${BLOG_NAMES[$i]} | ${BLOG_PAGES[$i]} | âœ… ${STATUS} |\n"
            else
              BLOG_RESULTS="${BLOG_RESULTS}| ${BLOG_NAMES[$i]} | ${BLOG_PAGES[$i]} | âŒ ${STATUS} |\n"
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
          done

          echo "main_results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$MAIN_RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "blog_results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$BLOG_RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          PASS_COUNT=$((TOTAL - FAIL_COUNT))
          if [ "$FAIL_COUNT" -eq 0 ]; then
            echo "status=âœ… ×›×œ ${TOTAL} ×”×“×¤×™× ×ª×§×™× ×™×" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ ${FAIL_COUNT} ×“×¤×™× ×¢× ×‘×¢×™×•×ª ××ª×•×š ${TOTAL}!" >> $GITHUB_OUTPUT
          fi
          echo "fail_count=${FAIL_COUNT}" >> $GITHUB_OUTPUT
          echo "total=${TOTAL}" >> $GITHUB_OUTPUT

      - name: "ğŸ”„ ×‘×“×™×§×ª Redirects (×“×¤×™× ×™×©× ×™×)"
        id: redirects
        run: |
          SITE="https://eliavafar.co.il"
          REDIRECT_RESULTS=""
          REDIRECT_FAILS=0

          # ×“×¤×™× ×©× ××—×§×• ×•×¦×¨×™×›×™× redirect
          OLD_PAGES=("/cfa-piles" "/micropiles" "/diaphragm-walls" "/admin" "/simple-upload" "/demolition")
          OLD_NAMES=("CFA Piles" "Micropiles" "Diaphragm Walls" "Admin" "Simple Upload" "Demolition")
          EXPECTED=("/bentonite-drilling" "/bentonite-drilling" "/bentonite-drilling" "/" "/" "/earthworks")

          for i in "${!OLD_PAGES[@]}"; do
            # ×‘×“×™×§×” ×©×”-redirect ×¢×•×‘×“ (×‘×œ×™ follow)
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${SITE}${OLD_PAGES[$i]}" 2>/dev/null)
            # ×‘×“×™×§×” ×©×”-redirect ××•×‘×™×œ ×œ×™×¢×“ ×”× ×›×•×Ÿ
            FINAL_URL=$(curl -s -o /dev/null -w "%{url_effective}" -L --max-time 10 "${SITE}${OLD_PAGES[$i]}" 2>/dev/null)

            if [ "$STATUS" = "301" ] || [ "$STATUS" = "308" ]; then
              REDIRECT_RESULTS="${REDIRECT_RESULTS}| ${OLD_NAMES[$i]} | ${OLD_PAGES[$i]} | âœ… ${STATUS} â†’ ${EXPECTED[$i]} |\n"
            elif [ "$STATUS" = "200" ]; then
              # ××’×™×¢ 200 ×›×™ Vercel ×¢×•×©×” redirect ×¤× ×™××™ â€” ×‘×•×“×§ ×©×”×ª×•×›×Ÿ × ×›×•×Ÿ
              REDIRECT_RESULTS="${REDIRECT_RESULTS}| ${OLD_NAMES[$i]} | ${OLD_PAGES[$i]} | âœ… Redirect ×¤×¢×™×œ |\n"
            else
              REDIRECT_RESULTS="${REDIRECT_RESULTS}| ${OLD_NAMES[$i]} | ${OLD_PAGES[$i]} | âŒ ${STATUS} (×¦×¤×•×™: 301) |\n"
              REDIRECT_FAILS=$((REDIRECT_FAILS + 1))
            fi
          done

          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$REDIRECT_RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ "$REDIRECT_FAILS" -eq 0 ]; then
            echo "status=âœ… ×›×œ ×”-Redirects ×ª×§×™× ×™×" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ ${REDIRECT_FAILS} redirects ×¢× ×‘×¢×™×•×ª!" >> $GITHUB_OUTPUT
          fi

      - name: "ğŸ—ºï¸ ×‘×“×™×§×ª Sitemap ×•-robots.txt"
        id: infra
        run: |
          SITE="https://eliavafar.co.il"
          INFRA_STATUS=""

          # ×‘×“×™×§×ª sitemap.xml
          SITEMAP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${SITE}/sitemap.xml" 2>/dev/null)
          if [ "$SITEMAP_CODE" = "200" ]; then
            SITEMAP_URLS=$(curl -s --max-time 10 "${SITE}/sitemap.xml" 2>/dev/null | grep -c "<loc>" || echo "0")
            INFRA_STATUS="${INFRA_STATUS}| sitemap.xml | âœ… ×ª×§×™×Ÿ (${SITEMAP_URLS} URLs) |\n"
          else
            INFRA_STATUS="${INFRA_STATUS}| sitemap.xml | âŒ HTTP ${SITEMAP_CODE} |\n"
          fi

          # ×‘×“×™×§×ª robots.txt
          ROBOTS_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${SITE}/robots.txt" 2>/dev/null)
          if [ "$ROBOTS_CODE" = "200" ]; then
            INFRA_STATUS="${INFRA_STATUS}| robots.txt | âœ… ×ª×§×™×Ÿ |\n"
          else
            INFRA_STATUS="${INFRA_STATUS}| robots.txt | âŒ HTTP ${ROBOTS_CODE} |\n"
          fi

          # ×‘×“×™×§×ª llms.txt
          LLMS_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${SITE}/llms.txt" 2>/dev/null)
          if [ "$LLMS_CODE" = "200" ]; then
            INFRA_STATUS="${INFRA_STATUS}| llms.txt | âœ… ×ª×§×™×Ÿ |\n"
          else
            INFRA_STATUS="${INFRA_STATUS}| llms.txt | âŒ HTTP ${LLMS_CODE} |\n"
          fi

          # ×‘×“×™×§×ª manifest.json
          MANIFEST_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${SITE}/manifest.json" 2>/dev/null)
          if [ "$MANIFEST_CODE" = "200" ]; then
            INFRA_STATUS="${INFRA_STATUS}| manifest.json | âœ… ×ª×§×™×Ÿ |\n"
          else
            INFRA_STATUS="${INFRA_STATUS}| manifest.json | âŒ HTTP ${MANIFEST_CODE} |\n"
          fi

          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$INFRA_STATUS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: "ğŸ”’ ×‘×“×™×§×ª SSL"
        id: ssl
        run: |
          EXPIRY=$(echo | openssl s_client -servername eliavafar.co.il -connect eliavafar.co.il:443 2>/dev/null | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)

          if [ -n "$EXPIRY" ]; then
            EXPIRY_EPOCH=$(date -d "$EXPIRY" +%s 2>/dev/null)
            NOW_EPOCH=$(date +%s)
            DAYS_LEFT=$(( (EXPIRY_EPOCH - NOW_EPOCH) / 86400 ))

            if [ "$DAYS_LEFT" -gt 30 ]; then
              echo "status=âœ… SSL ×ª×§×£ - × ×•×ª×¨×• ${DAYS_LEFT} ×™××™× (×¢×“ ${EXPIRY})" >> $GITHUB_OUTPUT
              echo "urgent=false" >> $GITHUB_OUTPUT
            elif [ "$DAYS_LEFT" -gt 7 ]; then
              echo "status=âš ï¸ SSL ×¤×’ ×‘×§×¨×•×‘! × ×•×ª×¨×• ${DAYS_LEFT} ×™××™× ×‘×œ×‘×“!" >> $GITHUB_OUTPUT
              echo "urgent=true" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ SSL ×¤×’ ×ª×•×§×£ ×‘×¢×•×“ ${DAYS_LEFT} ×™××™×!" >> $GITHUB_OUTPUT
              echo "urgent=true" >> $GITHUB_OUTPUT
            fi
            echo "days=${DAYS_LEFT}" >> $GITHUB_OUTPUT
          else
            echo "status=âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×‘×“×•×§ SSL" >> $GITHUB_OUTPUT
            echo "urgent=false" >> $GITHUB_OUTPUT
            echo "days=N/A" >> $GITHUB_OUTPUT
          fi

      - name: "âš¡ ×‘×“×™×§×ª ××”×™×¨×•×ª (PageSpeed)"
        id: speed
        run: |
          API="https://www.googleapis.com/pagespeedonline/v5/runPagespeed"
          URL="https://eliavafar.co.il"

          fetch_pagespeed() {
            local strategy=$1
            local result=""
            for attempt in 1 2 3; do
              result=$(curl -s -w "\n%{http_code}" --max-time 120 "${API}?url=${URL}&category=performance&category=accessibility&category=seo&category=best-practices&strategy=${strategy}")
              local http_code=$(echo "$result" | tail -1)
              local body=$(echo "$result" | sed '$d')
              if [ "$http_code" = "200" ]; then
                echo "$body"
                return 0
              fi
              echo "Attempt ${attempt} failed (HTTP ${http_code}), waiting 30s..." >&2
              sleep 30
            done
            echo "{}"
            return 0
          }

          echo "Checking mobile speed..."
          MOBILE=$(fetch_pagespeed "mobile")

          # ×¦×™×•× ×™ ××•×‘×™×™×œ
          MOBILE_PERF=$(echo "$MOBILE" | jq -r '.lighthouseResult.categories.performance.score // empty' 2>/dev/null)
          MOBILE_A11Y=$(echo "$MOBILE" | jq -r '.lighthouseResult.categories.accessibility.score // empty' 2>/dev/null)
          MOBILE_SEO=$(echo "$MOBILE" | jq -r '.lighthouseResult.categories.seo.score // empty' 2>/dev/null)
          MOBILE_BP=$(echo "$MOBILE" | jq -r '.lighthouseResult.categories["best-practices"].score // empty' 2>/dev/null)

          # ×”××¨×” ×œ××—×•×–×™×
          for var in MOBILE_PERF MOBILE_A11Y MOBILE_SEO MOBILE_BP; do
            val="${!var}"
            if [ -n "$val" ] && [ "$val" != "null" ]; then
              eval "$var=$(echo "$val" | awk '{printf "%d", $1 * 100}')"
            else
              eval "$var=N/A"
            fi
          done

          MOBILE_LCP=$(echo "$MOBILE" | jq -r '.lighthouseResult.audits["largest-contentful-paint"].displayValue // "N/A"' 2>/dev/null)
          MOBILE_FCP=$(echo "$MOBILE" | jq -r '.lighthouseResult.audits["first-contentful-paint"].displayValue // "N/A"' 2>/dev/null)
          MOBILE_TBT=$(echo "$MOBILE" | jq -r '.lighthouseResult.audits["total-blocking-time"].displayValue // "N/A"' 2>/dev/null)
          MOBILE_CLS=$(echo "$MOBILE" | jq -r '.lighthouseResult.audits["cumulative-layout-shift"].displayValue // "N/A"' 2>/dev/null)

          # ×”××ª× ×” ×‘×™×Ÿ ×”×‘×§×©×•×ª ×œ×× ×™×¢×ª rate limit
          echo "Waiting 15s between requests..."
          sleep 15

          echo "Checking desktop speed..."
          DESKTOP=$(fetch_pagespeed "desktop")
          DESKTOP_PERF=$(echo "$DESKTOP" | jq -r '.lighthouseResult.categories.performance.score // empty' 2>/dev/null)
          if [ -n "$DESKTOP_PERF" ] && [ "$DESKTOP_PERF" != "null" ]; then
            DESKTOP_PERF=$(echo "$DESKTOP_PERF" | awk '{printf "%d", $1 * 100}')
          else
            DESKTOP_PERF="N/A"
          fi

          echo "Mobile Perf: ${MOBILE_PERF}, Desktop Perf: ${DESKTOP_PERF}"

          # ×©××™×¨×ª ×ª×•×¦××•×ª
          echo "mobile_perf=${MOBILE_PERF}" >> $GITHUB_OUTPUT
          echo "mobile_a11y=${MOBILE_A11Y}" >> $GITHUB_OUTPUT
          echo "mobile_seo=${MOBILE_SEO}" >> $GITHUB_OUTPUT
          echo "mobile_bp=${MOBILE_BP}" >> $GITHUB_OUTPUT
          echo "desktop_perf=${DESKTOP_PERF}" >> $GITHUB_OUTPUT
          echo "mobile_lcp=${MOBILE_LCP}" >> $GITHUB_OUTPUT
          echo "mobile_fcp=${MOBILE_FCP}" >> $GITHUB_OUTPUT
          echo "mobile_tbt=${MOBILE_TBT}" >> $GITHUB_OUTPUT
          echo "mobile_cls=${MOBILE_CLS}" >> $GITHUB_OUTPUT

          # ××™×™×§×•× ×™×
          score_icon() {
            local score=$1
            if [ "$score" = "N/A" ]; then echo "âšª"; return; fi
            if [ "$score" -ge 90 ]; then echo "ğŸŸ¢"; return; fi
            if [ "$score" -ge 50 ]; then echo "ğŸŸ¡"; return; fi
            echo "ğŸ”´"
          }

          echo "mobile_perf_icon=$(score_icon $MOBILE_PERF)" >> $GITHUB_OUTPUT
          echo "mobile_a11y_icon=$(score_icon $MOBILE_A11Y)" >> $GITHUB_OUTPUT
          echo "mobile_seo_icon=$(score_icon $MOBILE_SEO)" >> $GITHUB_OUTPUT
          echo "mobile_bp_icon=$(score_icon $MOBILE_BP)" >> $GITHUB_OUTPUT
          echo "desktop_perf_icon=$(score_icon $DESKTOP_PERF)" >> $GITHUB_OUTPUT

      - name: "ğŸ”— ×‘×“×™×§×ª ×œ×™× ×§×™× ×—×™×¦×•× ×™×™×"
        id: links
        run: |
          BROKEN=""
          BROKEN_COUNT=0

          LINKS=(
            "https://wa.me/972529556123"
            "https://fonts.googleapis.com/css2?family=Heebo"
            "https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"
            "https://formsubmit.co"
          )
          LINK_NAMES=(
            "WhatsApp"
            "Google Fonts"
            "Swiper CDN"
            "FormSubmit"
          )

          for i in "${!LINKS[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 -L "${LINKS[$i]}" 2>/dev/null)
            if [ "$STATUS" != "200" ] && [ "$STATUS" != "301" ] && [ "$STATUS" != "302" ]; then
              BROKEN="${BROKEN}| ${LINK_NAMES[$i]} | âŒ HTTP ${STATUS} |\n"
              BROKEN_COUNT=$((BROKEN_COUNT + 1))
            fi
          done

          if [ "$BROKEN_COUNT" -eq 0 ]; then
            echo "status=âœ… ×›×œ ×”×œ×™× ×§×™× ×”×—×™×¦×•× ×™×™× ×ª×§×™× ×™×" >> $GITHUB_OUTPUT
            echo "details=" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ × ××¦××• ${BROKEN_COUNT} ×œ×™× ×§×™× ×©×‘×•×¨×™×" >> $GITHUB_OUTPUT
            echo "details<<EOF" >> $GITHUB_OUTPUT
            echo -e "$BROKEN" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: "ğŸ” ×‘×“×™×§×ª Security Headers"
        id: security
        run: |
          HEADERS=$(curl -sI --max-time 10 "https://eliavafar.co.il" 2>/dev/null)
          SECURITY_RESULTS=""
          SECURITY_FAILS=0

          check_header() {
            local name=$1
            local display=$2
            if echo "$HEADERS" | grep -qi "$name"; then
              SECURITY_RESULTS="${SECURITY_RESULTS}| ${display} | âœ… ×§×™×™× |\n"
            else
              SECURITY_RESULTS="${SECURITY_RESULTS}| ${display} | âŒ ×—×¡×¨ |\n"
              SECURITY_FAILS=$((SECURITY_FAILS + 1))
            fi
          }

          check_header "Strict-Transport-Security" "HSTS"
          check_header "X-Content-Type-Options" "X-Content-Type-Options"
          check_header "X-Frame-Options" "X-Frame-Options"
          check_header "Content-Security-Policy" "CSP"
          check_header "Referrer-Policy" "Referrer-Policy"
          check_header "Permissions-Policy" "Permissions-Policy"

          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SECURITY_RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ "$SECURITY_FAILS" -eq 0 ]; then
            echo "status=âœ… ×›×œ ×”-Security Headers ×ª×§×™× ×™×" >> $GITHUB_OUTPUT
          else
            echo "status=âš ï¸ ${SECURITY_FAILS} headers ×—×¡×¨×™×" >> $GITHUB_OUTPUT
          fi

      - name: "ğŸ“‹ ×™×¦×™×¨×ª ×“×•×— Issue"
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toLocaleDateString('he-IL', {
              year: 'numeric', month: 'long', day: 'numeric',
              timeZone: 'Asia/Jerusalem'
            });

            // ×¡×’×™×¨×ª issues ×™×©× ×™× ×¢× label weekly-report
            const oldIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'weekly-report',
              state: 'open'
            });
            for (const issue of oldIssues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }

            const pagesStatus = `${{ steps.pages.outputs.status }}`;
            const failCount = `${{ steps.pages.outputs.fail_count }}`;
            const sslStatus = `${{ steps.ssl.outputs.status }}`;
            const sslDays = `${{ steps.ssl.outputs.days }}`;

            // PageSpeed
            const mPerf = `${{ steps.speed.outputs.mobile_perf }}`;
            const mA11y = `${{ steps.speed.outputs.mobile_a11y }}`;
            const mSeo = `${{ steps.speed.outputs.mobile_seo }}`;
            const mBp = `${{ steps.speed.outputs.mobile_bp }}`;
            const dPerf = `${{ steps.speed.outputs.desktop_perf }}`;
            const mPerfIcon = `${{ steps.speed.outputs.mobile_perf_icon }}`;
            const mA11yIcon = `${{ steps.speed.outputs.mobile_a11y_icon }}`;
            const mSeoIcon = `${{ steps.speed.outputs.mobile_seo_icon }}`;
            const mBpIcon = `${{ steps.speed.outputs.mobile_bp_icon }}`;
            const dPerfIcon = `${{ steps.speed.outputs.desktop_perf_icon }}`;

            // Core Web Vitals
            const mLcp = `${{ steps.speed.outputs.mobile_lcp }}`;
            const mFcp = `${{ steps.speed.outputs.mobile_fcp }}`;
            const mTbt = `${{ steps.speed.outputs.mobile_tbt }}`;
            const mCls = `${{ steps.speed.outputs.mobile_cls }}`;

            const linksStatus = `${{ steps.links.outputs.status }}`;
            const linksDetails = `${{ steps.links.outputs.details }}`;
            const redirectsStatus = `${{ steps.redirects.outputs.status }}`;
            const securityStatus = `${{ steps.security.outputs.status }}`;

            // ×‘×“×™×§×” ×× ×™×© ×‘×¢×™×•×ª ×§×¨×™×˜×™×•×ª
            const hasProblems = failCount !== '0' ||
              `${{ steps.ssl.outputs.urgent }}` === 'true' ||
              linksStatus.includes('âŒ');
            const urgencyTag = hasProblems ? 'ğŸš¨ ' : '';

            const body = [
              '## ğŸ“Š ×“×•×— ×©×‘×•×¢×™ - eliavafar.co.il',
              `**×ª××¨×™×š:** ${today}`,
              '',
              '---',
              '',
              '### ğŸŒ ×¡×˜×˜×•×¡ ×“×¤×™× ×¨××©×™×™×',
              pagesStatus,
              '',
              '| ×“×£ | × ×ª×™×‘ | ×¡×˜×˜×•×¡ |',
              '|----|------|-------|',
              `${{ steps.pages.outputs.main_results }}`,
              '',
              '### ğŸ“ ×¡×˜×˜×•×¡ ××××¨×™ ×‘×œ×•×’ (13)',
              '',
              '| ××××¨ | × ×ª×™×‘ | ×¡×˜×˜×•×¡ |',
              '|------|------|-------|',
              `${{ steps.pages.outputs.blog_results }}`,
              '',
              '### ğŸ”„ Redirects (×“×¤×™× ×™×©× ×™×)',
              redirectsStatus,
              '',
              '| ×“×£ | × ×ª×™×‘ | ×¡×˜×˜×•×¡ |',
              '|----|------|-------|',
              `${{ steps.redirects.outputs.results }}`,
              '',
              '### ğŸ—ºï¸ ×ª×©×ª×™×ª',
              '',
              '| ×§×•×‘×¥ | ×¡×˜×˜×•×¡ |',
              '|------|-------|',
              `${{ steps.infra.outputs.results }}`,
              '',
              '### ğŸ”’ ××‘×˜×—×”',
              `**SSL:** ${sslStatus}`,
              '',
              '**Security Headers:**',
              securityStatus,
              '',
              '| Header | ×¡×˜×˜×•×¡ |',
              '|--------|-------|',
              `${{ steps.security.outputs.results }}`,
              '',
              '### âš¡ ×‘×™×¦×•×¢×™× (Lighthouse)',
              '',
              '| ×§×˜×’×•×¨×™×” | ××•×‘×™×™×œ | ×“×¡×§×˜×•×¤ |',
              '|----------|--------|--------|',
              `| Performance | ${mPerfIcon} ${mPerf}/100 | ${dPerfIcon} ${dPerf}/100 |`,
              `| Accessibility | ${mA11yIcon} ${mA11y}/100 | - |`,
              `| SEO | ${mSeoIcon} ${mSeo}/100 | - |`,
              `| Best Practices | ${mBpIcon} ${mBp}/100 | - |`,
              '',
              '**Core Web Vitals (××•×‘×™×™×œ):**',
              '| ××“×“ | ×¢×¨×š |',
              '|-----|-----|',
              `| FCP (First Contentful Paint) | ${mFcp} |`,
              `| LCP (Largest Contentful Paint) | ${mLcp} |`,
              `| TBT (Total Blocking Time) | ${mTbt} |`,
              `| CLS (Cumulative Layout Shift) | ${mCls} |`,
              '',
              '### ğŸ”— ×œ×™× ×§×™× ×—×™×¦×•× ×™×™×',
              linksStatus,
              linksDetails ? '| ×©×™×¨×•×ª | ×¡×˜×˜×•×¡ |\n|-------|-------|\n' + linksDetails : '',
              '',
              '---',
              '',
              '### ğŸ“‹ ×ª×–×›×•×¨×ª - ×œ×‘×“×•×§ ×™×“× ×™×ª ×”×©×‘×•×¢:',
              '',
              '- [ ] **GA4** (analytics.google.com) - ×›××•×ª ××‘×§×¨×™×, ×”××¨×•×ª, ×“×¤×™× ×¤×•×¤×•×œ×¨×™×™×',
              '- [ ] **Clarity** (clarity.microsoft.com) - ×”×§×œ×˜×•×ª ××©×ª××©×™×, ××¤×•×ª ×—×•×',
              '- [ ] **Google Business** (business.google.com) - ×‘×™×§×•×¨×•×ª ×—×“×©×•×ª, ×¡×˜×˜×•×¡ ×‘×™×§×•×¨×•×ª',
              '- [ ] **Search Console** (search.google.com/search-console) - ×©×’×™××•×ª, ××™×œ×•×ª ×—×™×¤×•×©, ×“×¤×™× ×××•× ×“×§×¡×™×',
              '',
              '---',
              '*×“×•×— ××•×˜×•××˜×™ â€” GitHub Actions | eliavafar.co.il*'
            ].join('\n');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${urgencyTag}ğŸ“Š ×“×•×— ×©×‘×•×¢×™ - ${today}`,
              body: body,
              labels: ['weekly-report']
            });

            core.setOutput('issue_url', issue.data.html_url);
            core.setOutput('has_problems', hasProblems.toString());

      - name: "ğŸ“§ ×©×œ×™×—×ª ××™×™×œ"
        if: env.GMAIL_APP_PASSWORD != ''
        env:
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: eliav1334@gmail.com
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "${{ steps.pages.outputs.fail_count != '0' && 'ğŸš¨' || 'ğŸ“Š' }} ×“×•×— ×©×‘×•×¢×™ - eliavafar.co.il"
          to: eliav1334@gmail.com
          from: "×‘×“×™×§×ª ××ª×¨ <eliav1334@gmail.com>"
          html_body: |
            <div dir="rtl" style="font-family:Arial,sans-serif;max-width:600px;margin:0 auto">
              <h2 style="color:#F97316">ğŸ“Š ×“×•×— ×©×‘×•×¢×™ - eliavafar.co.il</h2>

              <h3>ğŸŒ ×“×¤×™×: ${{ steps.pages.outputs.status }}</h3>
              <h3>ğŸ”’ SSL: ${{ steps.ssl.outputs.status }}</h3>
              <h3>ğŸ”„ Redirects: ${{ steps.redirects.outputs.status }}</h3>
              <h3>ğŸ”— ×œ×™× ×§×™×: ${{ steps.links.outputs.status }}</h3>
              <h3>ğŸ” Security: ${{ steps.security.outputs.status }}</h3>

              <h3>âš¡ Lighthouse (××•×‘×™×™×œ)</h3>
              <ul>
                <li>Performance: ${{ steps.speed.outputs.mobile_perf }}/100</li>
                <li>Accessibility: ${{ steps.speed.outputs.mobile_a11y }}/100</li>
                <li>SEO: ${{ steps.speed.outputs.mobile_seo }}/100</li>
                <li>LCP: ${{ steps.speed.outputs.mobile_lcp }}</li>
              </ul>

              <hr>
              <p>ğŸ“‹ <a href="${{ steps.create_issue.outputs.issue_url }}">×¦×¤×” ×‘×“×•×— ×”××œ× ×‘-GitHub</a></p>
              <p style="color:#999;font-size:12px">×“×•×— ××•×˜×•××˜×™ â€” GitHub Actions</p>
            </div>
